import streamlit as st
from PIL import Image
import src.helpers as helpers
import src.visualize as vis
from src.config import appProperties


def eda_tool(config):
    # ãƒãƒ«ãƒãƒšãƒ¼ã‚¸ã®è¨­å®š
    st.set_page_config(page_title="ç•°å¸¸å€¤ç®‡æ‰€ãƒã‚§ãƒƒã‚¯", layout="centered")
    st.sidebar.header("ç•°å¸¸ç®‡æ‰€ãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«")
    
    # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’é…ç½®ã™ã‚‹
    main_view = st.container()
    
    # ä½œæˆä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    main_view.warning("# ä¸€ç”Ÿæ‡¸å‘½ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆä¸­ã§ã™")
    img_sorry = Image.open('icons/sorry_panda.jpg')
    main_view.image(img_sorry, caption='We are working very hard on the program!')
    
    # ãƒ•ã‚©ãƒ«ãƒ€ç›´ä¸‹ã®ç”»åƒä¿ç®¡ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒªã‚¹ãƒˆ
    # images_path = helpers.list_imagespath(config.image_dir)
    # ä»–ãƒšãƒ¼ã‚¸ã§ã®çµæœã‚’åæ˜ ã™ã‚‹ãŸã‚nonCacheã‚’ä½¿ç”¨
    images_path = helpers.list_imagespath_nonCache(config.image_dir)
    
    # ç”»åƒä¿ç®¡ç·šåŒºã®é¸æŠ
    st.sidebar.markdown("# ___Step1___ ç·šåŒºã‚’é¸æŠ")

    # æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€ã®çµã‚Šè¾¼ã¿
    dir_search = st.sidebar.checkbox("æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º", value=False)
    if dir_search:
        dir_area_key = st.sidebar.text_input("ç·šåŒº æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰").lower()
        images_path_filtered = [path for path in images_path if dir_area_key in path.lower()]
        if dir_area_key:
            if not images_path_filtered:
                st.sidebar.error("å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚")
                st.stop()
        else:
            images_path_filtered = images_path
    else:
        images_path_filtered = images_path

    # å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€ã®é¸æŠ
    dir_area = st.sidebar.selectbox("ç·šåŒºã®ãƒ•ã‚©ãƒ«ãƒ€åã‚’é¸æŠã—ã¦ãã ã•ã„", images_path_filtered)
    if dir_area is None:
        st.error("No frames fit the criteria. Please select different label or number.")
        st.stop()

    # é¸æŠã•ã‚ŒãŸç·šåŒºæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
    vis.rail_info_view(dir_area, config, main_view)

    st.sidebar.markdown("# ___Step2___ è§£ææ¡ä»¶ã‚’è¨­å®š")
    # è§£æå¯¾è±¡ã®ã‚«ãƒ¡ãƒ©ç•ªå·ã‚’é¸æŠã™ã‚‹
    camera_name = st.sidebar.selectbox(
                    "è§£æå¯¾è±¡ã®ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„",
                    zip(config.camera_names, config.camera_types)
                    )[0]
    camera_num = config.camera_name_to_type[camera_name]

    # è§£æå¯¾è±¡ã®ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®š
    target_dir = config.image_dir + "/" + dir_area + "/" + camera_num

    # outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
    outpath = config.output_dir + "/" + dir_area + "/" + camera_num

    # imagesãƒ•ã‚©ãƒ«ãƒ€å†…ã®ç”»åƒä¸€è¦§å–å¾—
    base_images = helpers.list_images(target_dir)

    # çµæœä¿å­˜ç”¨ã®CSVãƒ•ã‚¡ã‚¤ãƒ«(rail)ã®ä¿å­˜ãƒ‘ã‚¹ã‚’æŒ‡å®š
    # rail_fpath = outpath + "/rail.shelve"
    rail_fpath = outpath + "/rail.csv"
    
    
    # è§£æçµæœãŒã‚ã‚‹ã‹ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã™ã‚‹
    st.sidebar.markdown("# å‚è€ƒ çµæœæœ‰ç„¡ğŸ‘‡")
    try:
        with open(rail_fpath) as csv:
            st.sidebar.download_button(
                label="CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=csv,
                file_name=dir_area + "_" + camera_num + "_output.csv",
                mime="text/csv"
            )
    except Exception as e:
        st.sidebar.error("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“")
        st.sidebar.write(f"Error> {e}")
    csv_delete_btn = st.sidebar.button("çµæœCSVãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹")
    if csv_delete_btn:
        if os.path.exists(rail_fpath):
            helpers.file_remove(rail_fpath)
            log_view.error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
        else:
            log_view.error("å‰Šé™¤ã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“")
    idx_result_check = st.sidebar.checkbox("è§£ææ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹", value=True)
    if idx_result_check:
        df = helpers.check_camera_dirs_addIdxLen(dir_area, config)
    else:
        df = helpers.check_camera_dirs(dir_area, config)
    st.sidebar.dataframe(df)
        
    return


if __name__ == "__main__":
    config = appProperties('config.yml')
    eda_tool(config)